import{_ as ee}from"./table-header-operation.vue_vue_type_script_setup_true_lang-ntuddL0e.js";import{bj as M,d as P,U as F,V as J,o as W,c as z,w as r,f as a,h as t,$ as e,n as te,p as D,B as $,bk as ae,g as v,t as B,a4 as C,bl as G,bm as O,bn as oe,N as U,bi as ne,bh as le,s as se,J as re,a8 as ie,W as ue,b as ce,a9 as V,S as me,I as pe,aa as de}from"./index-DQvTTbM-.js";import{f as be,a as fe}from"./job-UWaVutAa.js";import{_ as ge,u as E,N as q}from"./table-BY-eM7wn.js";import{_ as he}from"./search-form.vue_vue_type_script_setup_true_lang-gb65EZBS.js";import{_ as _e}from"./select-group.vue_vue_type_script_setup_true_lang-BFflBQVF.js";import{_ as je}from"./task-batch-status.vue_vue_type_script_setup_true_lang-KC0ydVlx.js";import{_ as ke}from"./detail-drawer-CbMhCQld.js";import{f as ve,_ as Be}from"./log-kdQNaTzi.js";import{_ as ye,a as we}from"./DescriptionsItem-Bd4R5YlG.js";import{b as H}from"./Grid-CSTnYjse.js";import"./Space-B5Upi9VN.js";import"./form-Bu4MD_Ly.js";import"./round-search-DSNvd4Y0.js";import"./group-DKztxFm0.js";import"./close-fullscreen-rounded-BQkrG2tL.js";import"./CollapseItem-Cc60zQbl.js";function Ne(u){return M({url:"/job/batch/list",method:"get",params:u})}function Se(u){return M({url:`/job/batch/stop/${u}`,method:"post"})}function De(u){return M({url:`/job/batch/retry/${u}`,method:"post"})}const xe=P({name:"JobBatchSearch",__name:"job-batch-search",props:{model:{required:!0},modelModifiers:{}},emits:F(["reset","search"],["update:model"]),setup(u,{emit:w}){const d=w,p=J(u,"model");function f(){d("reset")}function S(){d("search")}return(N,g)=>{const y=ge,b=te,h=he;return W(),z(h,{model:p.value,onSearch:S,onReset:f},{default:r(()=>[a(y,{span:"24 s:12 m:6",label:t(e)("page.jobBatch.groupName"),path:"groupName",class:"pr-24px"},{default:r(()=>[a(_e,{value:p.value.groupName,"onUpdate:value":g[0]||(g[0]=_=>p.value.groupName=_)},null,8,["value"])]),_:1},8,["label"]),a(y,{span:"24 s:12 m:6",label:t(e)("page.jobBatch.jobName"),path:"jobName",class:"pr-24px"},{default:r(()=>[a(b,{value:p.value.jobName,"onUpdate:value":g[1]||(g[1]=_=>p.value.jobName=_),placeholder:t(e)("page.jobBatch.form.jobName")},null,8,["value","placeholder"])]),_:1},8,["label"]),a(y,{span:"24 s:12 m:6",label:t(e)("page.jobBatch.taskBatchStatus"),path:"taskBatchStatus",class:"pr-24px"},{default:r(()=>[a(je,{value:p.value.taskBatchStatus,"onUpdate:value":g[2]||(g[2]=_=>p.value.taskBatchStatus=_)},null,8,["value"])]),_:1},8,["label"])]),_:1},8,["model"])}}}),Ie=P({name:"JobBatchDetailDrawer",__name:"job-batch-detail-drawer",props:F({rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{},logShow:{type:Boolean,default:!1},logShowModifiers:{}}),emits:["update:visible","update:logShow"],setup(u){var l,o;const w=u,d=D(),p=J(u,"visible"),f=J(u,"logShow"),{columns:S,data:N,loading:g,mobilePagination:y}=E({apiFn:be,apiParams:{page:1,size:10,groupName:(l=w.rowData)==null?void 0:l.groupName,taskBatchId:(o=w.rowData)==null?void 0:o.id,startId:0,fromIndex:0},columns:()=>[{key:"index",title:e("common.index"),align:"center",width:64,render:n=>{async function i(){f.value=!0,d.value=n,await T()}return a($,{type:"info",text:!0,onClick:i},{default:()=>[a("span",{class:"w-28px ws-break-spaces"},[e("page.log.view")])]})}},{key:"id",title:e("page.jobBatch.jobTask.id"),align:"left",minWidth:64},{key:"groupName",title:e("page.jobBatch.jobTask.groupName"),align:"left",minWidth:120},{key:"clientInfo",title:e("page.jobBatch.jobTask.clientInfo"),align:"left",minWidth:120,render:n=>{var i;if(n.clientInfo){const c=(i=n.clientInfo)==null?void 0:i.split("@"),m=c.length>1?c[1]:"";return a("div",null,[m])}return a("div",null,[n.clientInfo])}},{key:"argsStr",title:e("page.jobBatch.jobTask.argsStr"),align:"left",minWidth:120},{key:"resultMessage",title:e("page.jobBatch.jobTask.resultMessage"),align:"left",minWidth:120},{key:"retryCount",title:e("page.jobBatch.jobTask.retryCount"),align:"left",minWidth:64},{key:"createDt",title:e("page.jobBatch.jobTask.createDt"),align:"left",minWidth:120}]}),b=D([]),h=D(),_=new AbortController,j=D(!1);let x="0",I=0;async function T(){const{data:n,error:i}=await ve({taskBatchId:d.value.taskBatchId,jobId:d.value.jobId,taskId:d.value.id,startId:x,fromIndex:I,size:50});i||(j.value=n.finished,x=n.nextStartId,I=n.fromIndex,n.message&&(b.value.push(...n.message),b.value.sort((c,m)=>Number.parseInt(c.time_stamp,10)-Number.parseInt(m.time_stamp,10))),j.value||(clearTimeout(h.value),h.value=setTimeout(T,1e3)))}const L=()=>{j.value=!0,_.abort(),clearTimeout(h.value),h.value=void 0};return ae(()=>{L()}),(n,i)=>{const c=ye,m=U,Q=we,A=ne,K=H,X=le,Y=Be,Z=ke;return W(),z(Z,{modelValue:p.value,"onUpdate:modelValue":i[2]||(i[2]=s=>p.value=s),title:t(e)("page.jobBatch.detail"),width:["50%","90%"]},{default:r(()=>[a(X,{type:"segment",animated:""},{default:r(()=>[a(A,{name:0,tab:t(e)("page.log.info")},{default:r(()=>[a(Q,{"label-placement":"top",bordered:"",column:2},{default:r(()=>[a(c,{label:t(e)("page.jobBatch.groupName")},{default:r(()=>{var s;return[v(B((s=n.rowData)==null?void 0:s.groupName),1)]}),_:1},8,["label"]),a(c,{label:t(e)("page.jobBatch.jobName")},{default:r(()=>{var s;return[v(B((s=n.rowData)==null?void 0:s.jobName),1)]}),_:1},8,["label"]),a(c,{label:t(e)("page.jobBatch.taskBatchStatus")},{default:r(()=>{var s;return[a(m,{type:t(C)((s=n.rowData)==null?void 0:s.taskBatchStatus)},{default:r(()=>{var k;return[v(B(t(e)(t(G)[(k=n.rowData)==null?void 0:k.taskBatchStatus])),1)]}),_:1},8,["type"])]}),_:1},8,["label"]),a(c,{label:t(e)("page.jobBatch.executionAt")},{default:r(()=>{var s;return[v(B((s=n.rowData)==null?void 0:s.executionAt),1)]}),_:1},8,["label"]),a(c,{label:t(e)("page.jobBatch.operationReason")},{default:r(()=>{var s;return[a(m,{type:t(C)((s=n.rowData)==null?void 0:s.operationReason)},{default:r(()=>{var k;return[v(B(t(e)(t(O)[(k=n.rowData)==null?void 0:k.operationReason])),1)]}),_:1},8,["type"])]}),_:1},8,["label"]),a(c,{label:t(e)("page.jobBatch.executorType")},{default:r(()=>{var s;return[a(m,{type:t(C)((s=n.rowData)==null?void 0:s.executorType)},{default:r(()=>{var k;return[v(B(t(e)(t(oe)[(k=n.rowData)==null?void 0:k.executorType])),1)]}),_:1},8,["type"])]}),_:1},8,["label"]),a(c,{label:t(e)("page.jobBatch.executorInfo"),span:2},{default:r(()=>{var s;return[v(B((s=n.rowData)==null?void 0:s.executorInfo),1)]}),_:1},8,["label"]),a(c,{label:t(e)("common.createDt"),span:2},{default:r(()=>{var s;return[v(B((s=n.rowData)==null?void 0:s.createDt),1)]}),_:1},8,["label"])]),_:1})]),_:1},8,["tab"]),a(A,{name:1,tab:t(e)("page.log.title"),"display-directive":"if"},{default:r(()=>[a(K,{columns:t(S),data:t(N),loading:t(g),remote:"","row-key":s=>s.id,pagination:t(y),class:"sm:h-full"},null,8,["columns","data","loading","row-key","pagination"])]),_:1},8,["tab"])]),_:1}),a(Y,{modelValue:b.value,"onUpdate:modelValue":i[0]||(i[0]=s=>b.value=s),show:f.value,"onUpdate:show":i[1]||(i[1]=s=>f.value=s),title:t(e)("page.log.title")},null,8,["modelValue","show","title"])]),_:1},8,["modelValue","title"])}}}),Te={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function R(u){return typeof u=="function"||Object.prototype.toString.call(u)==="[object Object]"&&!de(u)}const He=P({name:"job_batch",__name:"index",setup(u){const w=se(),d=re(),p=D(),{bool:f,setTrue:S}=ie(!1),{columnChecks:N,columns:g,data:y,getData:b,loading:h,mobilePagination:_,searchParams:j,resetSearchParams:x}=E({apiFn:Ne,apiParams:{page:1,size:10,groupName:null,jobName:null,taskBatchStatus:null},columns:()=>[{key:"id",title:e("common.index"),align:"center",width:64,render:l=>{function o(){p.value=l,S()}return a($,{text:!0,tag:"a",type:"primary",onClick:o,class:"ws-normal"},{default:()=>[l.id]})}},{key:"groupName",title:e("page.jobBatch.groupName"),align:"left",minWidth:120},{key:"jobName",title:e("page.jobBatch.jobName"),align:"center",minWidth:120},{key:"executionAt",title:e("page.jobBatch.executionAt"),align:"center",minWidth:120},{key:"taskBatchStatus",title:e("page.jobBatch.taskBatchStatus"),align:"center",minWidth:120,render:l=>{if(l.taskBatchStatus===null)return null;const o=e(G[l.taskBatchStatus]);return a(U,{type:{1:"info",2:"info",3:"info",4:"error",5:"error",6:"error"}[l.taskBatchStatus]},R(o)?o:{default:()=>[o]})}},{key:"operationReason",title:e("page.jobBatch.operationReason"),align:"center",minWidth:120,render:l=>{if(l.operationReason===null)return null;const o=e(O[l.operationReason]);return a(U,{type:C(l.operationReason)},R(o)?o:{default:()=>[o]})}},{key:"operate",title:e("common.operate"),align:"center",width:130,render:l=>a("div",{class:"flex-center gap-8px"},[l.taskBatchStatus===1||l.taskBatchStatus===2?a(q,{onPositiveClick:()=>T(l.id)},{default:()=>e("common.confirmStop"),trigger:()=>{let o;return a($,{type:"error",ghost:!0,size:"small"},R(o=e("common.stop"))?o:{default:()=>[o]})}}):"",l.taskBatchStatus===4||l.taskBatchStatus===5||l.taskBatchStatus===6?a(q,{onPositiveClick:()=>I(l.id)},{default:()=>e("common.confirmRetry"),trigger:()=>{let o;return a($,{type:"warning",ghost:!0,size:"small"},R(o=e("common.retry"))?o:{default:()=>[o]})}}):""])}]});async function I(l){var n;const{error:o}=await De(l);o||((n=window.$message)==null||n.success(e("common.operateSuccess")),b())}async function T(l){var n;const{error:o}=await Se(l);o||((n=window.$message)==null||n.success(e("common.operateSuccess")),b())}async function L(l){if(!l)j.jobName=null;else{const{data:o,error:n}=await fe({jobId:l});if(!n&&o.length>0){const i=o[0].jobName;j.jobName=i}}b()}return ue(()=>d.query,()=>{if(d.name==="job_batch"&&d.query.jobId){const l=Number(d.query.jobId);L(l)}},{immediate:!0}),(l,o)=>{const n=ee,i=H,c=pe;return W(),ce("div",Te,[a(xe,{model:t(j),"onUpdate:model":o[0]||(o[0]=m=>V(j)?j.value=m:null),onReset:t(x),onSearch:t(b)},null,8,["model","onReset","onSearch"]),a(c,{title:t(e)("page.jobBatch.title"),bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper","header-class":"view-card-header"},{"header-extra":r(()=>[a(n,{columns:t(N),"onUpdate:columns":o[1]||(o[1]=m=>V(N)?N.value=m:null),loading:t(h),"show-delete":!1,"show-add":!1,onRefresh:t(b)},null,8,["columns","loading","onRefresh"])]),default:r(()=>[a(i,{columns:t(g),data:t(y),"flex-height":!t(w).isMobile,"scroll-x":962,loading:t(h),remote:"","row-key":m=>m.id,pagination:t(_),class:"sm:h-full"},null,8,["columns","data","flex-height","loading","row-key","pagination"])]),_:1},8,["title"]),t(f)?(W(),z(Ie,{key:0,visible:t(f),"onUpdate:visible":o[2]||(o[2]=m=>V(f)?f.value=m:null),"row-data":p.value},null,8,["visible","row-data"])):me("",!0)])}}});export{He as default};
