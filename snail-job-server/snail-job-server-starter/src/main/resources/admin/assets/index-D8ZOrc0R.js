import{_ as ee,u as O,N as q,b as te}from"./table-Bdl3-G-Y.js";import{bi as U,d as P,U as F,V as J,o as L,c as z,w as r,f as a,h as t,$ as e,n as ae,p as x,B as W,bj as oe,N as w,bk as ne,g as y,t as B,a8 as C,bl as G,bm as E,bn as le,ae as H,bg as se,bh as re,s as ie,J as ue,ac as ce,W as pe,b as me,ad as V,S as de,I as be}from"./index-CHgAHQIl.js";import{f as fe,a as ge}from"./job-ClIVIZwj.js";import{_ as he}from"./search-form.vue_vue_type_script_setup_true_lang-BfZ4by1v.js";import{_ as _e}from"./select-group.vue_vue_type_script_setup_true_lang-fZ9yr9an.js";import{_ as ke}from"./task-batch-status.vue_vue_type_script_setup_true_lang-CZqj1cRx.js";import{_ as je}from"./detail-drawer-CWz6q5KO.js";import{f as ye,_ as Be}from"./log-BNPnMg-G.js";import{_ as ve,a as Se}from"./DescriptionsItem-sCQ7QkHp.js";import{_ as Q}from"./Grid-DHGKk79k.js";import"./FormItem-B3tfy17D.js";import"./Space-CeVCCXQI.js";import"./round-search-KK91k1IY.js";import"./form-BuwwOwyC.js";import"./group-BUALrrKR.js";import"./close-fullscreen-rounded-DtEdfPev.js";function Ne(u){return U({url:"/job/batch/list",method:"get",params:u})}function we(u){return U({url:`/job/batch/stop/${u}`,method:"post"})}function De(u){return U({url:`/job/batch/retry/${u}`,method:"post"})}const xe=P({name:"JobBatchSearch",__name:"job-batch-search",props:{model:{required:!0},modelModifiers:{}},emits:F(["reset","search"],["update:model"]),setup(u,{emit:S}){const d=S,p=J(u,"model");function f(){d("reset")}function D(){d("search")}return(N,g)=>{const v=ee,b=ae,h=he;return L(),z(h,{model:p.value,onSearch:D,onReset:f},{default:r(()=>[a(v,{span:"24 s:12 m:6",label:t(e)("page.jobBatch.groupName"),path:"groupName",class:"pr-24px"},{default:r(()=>[a(_e,{value:p.value.groupName,"onUpdate:value":g[0]||(g[0]=_=>p.value.groupName=_)},null,8,["value"])]),_:1},8,["label"]),a(v,{span:"24 s:12 m:6",label:t(e)("page.jobBatch.jobName"),path:"jobName",class:"pr-24px"},{default:r(()=>[a(b,{value:p.value.jobName,"onUpdate:value":g[1]||(g[1]=_=>p.value.jobName=_),placeholder:t(e)("page.jobBatch.form.jobName")},null,8,["value","placeholder"])]),_:1},8,["label"]),a(v,{span:"24 s:12 m:6",label:t(e)("page.jobBatch.taskBatchStatus"),path:"taskBatchStatus",class:"pr-24px"},{default:r(()=>[a(ke,{value:p.value.taskBatchStatus,"onUpdate:value":g[2]||(g[2]=_=>p.value.taskBatchStatus=_)},null,8,["value"])]),_:1},8,["label"])]),_:1},8,["model"])}}});function Ie(u){return typeof u=="function"||Object.prototype.toString.call(u)==="[object Object]"&&!H(u)}const Te=P({name:"JobBatchDetailDrawer",__name:"job-batch-detail-drawer",props:F({rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{},logShow:{type:Boolean,default:!1},logShowModifiers:{}}),emits:["update:visible","update:logShow"],setup(u){var l,n;const S=u,d=x(),p=J(u,"visible"),f=J(u,"logShow"),{columns:D,data:N,loading:g,mobilePagination:v}=O({apiFn:fe,apiParams:{page:1,size:10,groupName:(l=S.rowData)==null?void 0:l.groupName,taskBatchId:(n=S.rowData)==null?void 0:n.id,startId:0,fromIndex:0},columns:()=>[{key:"index",title:e("common.index"),align:"center",width:64,render:o=>{async function i(){f.value=!0,d.value=o,await R()}return a(W,{type:"info",text:!0,onClick:i},{default:()=>[a("span",{class:"w-28px ws-break-spaces"},[e("page.log.view")])]})}},{key:"id",title:e("page.jobBatch.jobTask.id"),align:"left",minWidth:64},{key:"groupName",title:e("page.jobBatch.jobTask.groupName"),align:"left",minWidth:120},{key:"taskStatus",title:e("page.jobBatch.jobTask.taskStatus"),align:"left",minWidth:80,render:o=>{if(o.taskStatus===null)return null;const i=e(oe[o.taskStatus]);return a(w,{type:{1:"info",2:"info",3:"info",4:"error",5:"error",6:"error"}[o.taskStatus]},Ie(i)?i:{default:()=>[i]})}},{key:"clientInfo",title:e("page.jobBatch.jobTask.clientInfo"),align:"left",minWidth:120,render:o=>{var i;if(o.clientInfo){const c=(i=o.clientInfo)==null?void 0:i.split("@"),m=c.length>1?c[1]:"";return a("div",null,[m])}return a("div",null,[o.clientInfo])}},{key:"argsStr",title:e("page.jobBatch.jobTask.argsStr"),align:"left",minWidth:120},{key:"resultMessage",title:e("page.jobBatch.jobTask.resultMessage"),align:"left",minWidth:120},{key:"retryCount",title:e("page.jobBatch.jobTask.retryCount"),align:"left",minWidth:64},{key:"createDt",title:e("page.jobBatch.jobTask.createDt"),align:"left",minWidth:120}]}),b=x([]),h=x(),_=new AbortController,k=x(!1);let I="0",T=0;async function R(){const{data:o,error:i}=await ye({taskBatchId:d.value.taskBatchId,jobId:d.value.jobId,taskId:d.value.id,startId:I,fromIndex:T,size:50});i||(k.value=o.finished,I=o.nextStartId,T=o.fromIndex,o.message&&(b.value.push(...o.message),b.value.sort((c,m)=>Number.parseInt(c.time_stamp,10)-Number.parseInt(m.time_stamp,10))),k.value||(clearTimeout(h.value),h.value=setTimeout(R,1e3)))}const M=()=>{k.value=!0,_.abort(),clearTimeout(h.value),h.value=void 0};return ne(()=>{M()}),(o,i)=>{const c=ve,m=Se,A=se,K=Q,X=re,Y=Be,Z=je;return L(),z(Z,{modelValue:p.value,"onUpdate:modelValue":i[2]||(i[2]=s=>p.value=s),title:t(e)("page.jobBatch.detail"),width:["50%","90%"]},{default:r(()=>[a(X,{type:"segment",animated:""},{default:r(()=>[a(A,{name:0,tab:t(e)("page.log.info")},{default:r(()=>[a(m,{"label-placement":"top",bordered:"",column:2},{default:r(()=>[a(c,{label:t(e)("page.jobBatch.groupName")},{default:r(()=>{var s;return[y(B((s=o.rowData)==null?void 0:s.groupName),1)]}),_:1},8,["label"]),a(c,{label:t(e)("page.jobBatch.jobName")},{default:r(()=>{var s;return[y(B((s=o.rowData)==null?void 0:s.jobName),1)]}),_:1},8,["label"]),a(c,{label:t(e)("page.jobBatch.taskBatchStatus")},{default:r(()=>{var s;return[a(t(w),{type:t(C)((s=o.rowData)==null?void 0:s.taskBatchStatus)},{default:r(()=>{var j;return[y(B(t(e)(t(G)[(j=o.rowData)==null?void 0:j.taskBatchStatus])),1)]}),_:1},8,["type"])]}),_:1},8,["label"]),a(c,{label:t(e)("page.jobBatch.executionAt")},{default:r(()=>{var s;return[y(B((s=o.rowData)==null?void 0:s.executionAt),1)]}),_:1},8,["label"]),a(c,{label:t(e)("page.jobBatch.operationReason")},{default:r(()=>{var s;return[a(t(w),{type:t(C)((s=o.rowData)==null?void 0:s.operationReason)},{default:r(()=>{var j;return[y(B(t(e)(t(E)[(j=o.rowData)==null?void 0:j.operationReason])),1)]}),_:1},8,["type"])]}),_:1},8,["label"]),a(c,{label:t(e)("page.jobBatch.executorType")},{default:r(()=>{var s;return[a(t(w),{type:t(C)((s=o.rowData)==null?void 0:s.executorType)},{default:r(()=>{var j;return[y(B(t(e)(t(le)[(j=o.rowData)==null?void 0:j.executorType])),1)]}),_:1},8,["type"])]}),_:1},8,["label"]),a(c,{label:t(e)("page.jobBatch.executorInfo"),span:2},{default:r(()=>{var s;return[y(B((s=o.rowData)==null?void 0:s.executorInfo),1)]}),_:1},8,["label"]),a(c,{label:t(e)("common.createDt"),span:2},{default:r(()=>{var s;return[y(B((s=o.rowData)==null?void 0:s.createDt),1)]}),_:1},8,["label"])]),_:1})]),_:1},8,["tab"]),a(A,{name:1,tab:t(e)("page.log.title"),"display-directive":"if"},{default:r(()=>[a(K,{columns:t(D),data:t(N),loading:t(g),remote:"","row-key":s=>s.id,pagination:t(v),class:"sm:h-full"},null,8,["columns","data","loading","row-key","pagination"])]),_:1},8,["tab"])]),_:1}),a(Y,{modelValue:b.value,"onUpdate:modelValue":i[0]||(i[0]=s=>b.value=s),show:f.value,"onUpdate:show":i[1]||(i[1]=s=>f.value=s),title:t(e)("page.log.title")},null,8,["modelValue","show","title"])]),_:1},8,["modelValue","title"])}}}),Re={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function $(u){return typeof u=="function"||Object.prototype.toString.call(u)==="[object Object]"&&!H(u)}const He=P({name:"job_batch",__name:"index",setup(u){const S=ie(),d=ue(),p=x(),{bool:f,setTrue:D}=ce(!1),{columnChecks:N,columns:g,data:v,getData:b,loading:h,mobilePagination:_,searchParams:k,resetSearchParams:I}=O({apiFn:Ne,apiParams:{page:1,size:10,groupName:null,jobName:null,taskBatchStatus:null},columns:()=>[{key:"id",title:e("common.index"),align:"center",width:120,render:l=>{function n(){p.value=l,D()}return a(W,{text:!0,tag:"a",type:"primary",onClick:n,class:"ws-normal"},{default:()=>[l.id]})}},{key:"groupName",title:e("page.jobBatch.groupName"),align:"left",minWidth:120},{key:"jobName",title:e("page.jobBatch.jobName"),align:"center",minWidth:120},{key:"executionAt",title:e("page.jobBatch.executionAt"),align:"center",minWidth:120},{key:"taskBatchStatus",title:e("page.jobBatch.taskBatchStatus"),align:"center",minWidth:120,render:l=>{if(l.taskBatchStatus===null)return null;const n=e(G[l.taskBatchStatus]);return a(w,{type:{1:"info",2:"info",3:"info",4:"error",5:"error",6:"error"}[l.taskBatchStatus]},$(n)?n:{default:()=>[n]})}},{key:"operationReason",title:e("page.jobBatch.operationReason"),align:"center",minWidth:120,render:l=>{if(l.operationReason===null)return null;const n=e(E[l.operationReason]);return a(w,{type:C(l.operationReason)},$(n)?n:{default:()=>[n]})}},{key:"createDt",title:e("common.createDt"),align:"center",minWidth:120},{key:"operate",title:e("common.operate"),align:"center",width:130,render:l=>a("div",{class:"flex-center gap-8px"},[l.taskBatchStatus===1||l.taskBatchStatus===2?a(q,{onPositiveClick:()=>R(l.id)},{default:()=>e("common.confirmStop"),trigger:()=>{let n;return a(W,{type:"error",text:!0,ghost:!0,size:"small"},$(n=e("common.stop"))?n:{default:()=>[n]})}}):"",l.taskBatchStatus===4||l.taskBatchStatus===5||l.taskBatchStatus===6?a(q,{onPositiveClick:()=>T(l.id)},{default:()=>e("common.confirmRetry"),trigger:()=>{let n;return a(W,{type:"error",text:!0,ghost:!0,size:"small"},$(n=e("common.retry"))?n:{default:()=>[n]})}}):""])}]});async function T(l){var o;const{error:n}=await De(l);n||((o=window.$message)==null||o.success(e("common.operateSuccess")),b())}async function R(l){var o;const{error:n}=await we(l);n||((o=window.$message)==null||o.success(e("common.operateSuccess")),b())}async function M(l){if(!l)k.jobName=null;else{const{data:n,error:o}=await ge({jobId:l});if(!o&&n.length>0){const i=n[0].jobName;k.jobName=i}}b()}return pe(()=>d.query,()=>{if(d.name==="job_batch"&&d.query.jobId){const l=Number(d.query.jobId);M(l)}},{immediate:!0}),(l,n)=>{const o=te,i=Q,c=be;return L(),me("div",Re,[a(xe,{model:t(k),"onUpdate:model":n[0]||(n[0]=m=>V(k)?k.value=m:null),onReset:t(I),onSearch:t(b)},null,8,["model","onReset","onSearch"]),a(c,{title:t(e)("page.jobBatch.title"),bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper","header-class":"view-card-header"},{"header-extra":r(()=>[a(o,{columns:t(N),"onUpdate:columns":n[1]||(n[1]=m=>V(N)?N.value=m:null),loading:t(h),"show-delete":!1,"show-add":!1,onRefresh:t(b)},null,8,["columns","loading","onRefresh"])]),default:r(()=>[a(i,{columns:t(g),data:t(v),"flex-height":!t(S).isMobile,"scroll-x":962,loading:t(h),remote:"","row-key":m=>m.id,pagination:t(_),class:"sm:h-full"},null,8,["columns","data","flex-height","loading","row-key","pagination"])]),_:1},8,["title"]),t(f)?(L(),z(Te,{key:0,visible:t(f),"onUpdate:visible":n[2]||(n[2]=m=>V(f)?f.value=m:null),"row-data":p.value},null,8,["visible","row-data"])):de("",!0)])}}});export{He as default};
