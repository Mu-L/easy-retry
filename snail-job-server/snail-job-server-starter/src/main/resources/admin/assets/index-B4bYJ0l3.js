import{a as ee,b as te,u as O,N as A,d as ae}from"./search-form.vue_vue_type_script_setup_true_lang-CHQfNlLV.js";import{bm as U,d as z,Q as F,R as J,o as M,c as q,w as r,f as o,h as a,$ as t,s as oe,z as x,B as W,bn as ne,P as w,bo as le,g as j,t as y,a9 as L,bp as G,bq as Q,br as se,ag as E,bk as re,bl as ie,C as ue,bs as ce,ad as pe,S as me,b as de,ae as V,af as be,O as fe}from"./index-KP_OAqI5.js";import{f as ge,a as he}from"./job-CLFhv-05.js";import{_ as _e}from"./select-group.vue_vue_type_script_setup_true_lang-j0kz2NfN.js";import{_ as ke}from"./task-batch-status.vue_vue_type_script_setup_true_lang-pMxRF8YH.js";import{_ as je}from"./detail-drawer-cn9EnkBY.js";import{f as ye,_ as Be}from"./log-DQJkGq1i.js";import{_ as ve,a as Se}from"./DescriptionsItem-Q6F3Fays.js";import{_ as H}from"./Grid-D4q1Pq5a.js";import"./group-BnlgYRpp.js";function Ne(i){return U({url:"/job/batch/list",method:"get",params:i})}function we(i){return U({url:`/job/batch/stop/${i}`,method:"post"})}function De(i){return U({url:`/job/batch/retry/${i}`,method:"post"})}const xe=z({name:"JobBatchSearch",__name:"job-batch-search",props:{model:{required:!0},modelModifiers:{}},emits:F(["reset","search"],["update:model"]),setup(i,{emit:S}){const m=S,c=J(i,"model");function d(){m("reset")}function D(){m("search")}return(N,b)=>{const B=ee,p=oe,h=te;return M(),q(h,{model:c.value,onSearch:D,onReset:d},{default:r(()=>[o(B,{span:"24 s:12 m:6",label:a(t)("page.jobBatch.groupName"),path:"groupName",class:"pr-24px"},{default:r(()=>[o(_e,{value:c.value.groupName,"onUpdate:value":b[0]||(b[0]=_=>c.value.groupName=_)},null,8,["value"])]),_:1},8,["label"]),o(B,{span:"24 s:12 m:6",label:a(t)("page.jobBatch.jobName"),path:"jobName",class:"pr-24px"},{default:r(()=>[o(p,{value:c.value.jobName,"onUpdate:value":b[1]||(b[1]=_=>c.value.jobName=_),placeholder:a(t)("page.jobBatch.form.jobName")},null,8,["value","placeholder"])]),_:1},8,["label"]),o(B,{span:"24 s:12 m:6",label:a(t)("page.jobBatch.taskBatchStatus"),path:"taskBatchStatus",class:"pr-24px"},{default:r(()=>[o(ke,{value:c.value.taskBatchStatus,"onUpdate:value":b[2]||(b[2]=_=>c.value.taskBatchStatus=_)},null,8,["value"])]),_:1},8,["label"])]),_:1},8,["model"])}}});function Ie(i){return typeof i=="function"||Object.prototype.toString.call(i)==="[object Object]"&&!E(i)}const Te=z({name:"JobBatchDetailDrawer",__name:"job-batch-detail-drawer",props:F({rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{},logShow:{type:Boolean,default:!1},logShowModifiers:{}}),emits:["update:visible","update:logShow"],setup(i){var $,n;const S=i,m=x(),c=J(i,"visible"),d=J(i,"logShow"),{columns:D,data:N,loading:b,mobilePagination:B}=O({apiFn:ge,apiParams:{page:1,size:10,groupName:($=S.rowData)==null?void 0:$.groupName,taskBatchId:(n=S.rowData)==null?void 0:n.id,startId:0,fromIndex:0},columns:()=>[{key:"index",title:t("common.index"),align:"center",width:64,render:e=>{async function s(){d.value=!0,m.value=e,await R()}return o(W,{type:"info",text:!0,onClick:s},{default:()=>[o("span",{class:"w-28px ws-break-spaces"},[t("page.log.view")])]})}},{key:"id",title:t("page.jobBatch.jobTask.id"),align:"left",minWidth:64},{key:"groupName",title:t("page.jobBatch.jobTask.groupName"),align:"left",minWidth:120},{key:"taskStatus",title:t("page.jobBatch.jobTask.taskStatus"),align:"left",minWidth:80,render:e=>{if(e.taskStatus===null)return null;const s=t(ne[e.taskStatus]);return o(w,{type:{1:"info",2:"info",3:"info",4:"error",5:"error",6:"error"}[e.taskStatus]},Ie(s)?s:{default:()=>[s]})}},{key:"clientInfo",title:t("page.jobBatch.jobTask.clientInfo"),align:"left",minWidth:120,render:e=>{var s;if(e.clientInfo){const u=(s=e.clientInfo)==null?void 0:s.split("@"),v=u.length>1?u[1]:"";return o("div",null,[v])}return o("div",null,[e.clientInfo])}},{key:"argsStr",title:t("page.jobBatch.jobTask.argsStr"),align:"left",minWidth:120},{key:"resultMessage",title:t("page.jobBatch.jobTask.resultMessage"),align:"left",minWidth:120},{key:"retryCount",title:t("page.jobBatch.jobTask.retryCount"),align:"left",minWidth:64},{key:"createDt",title:t("page.jobBatch.jobTask.createDt"),align:"left",minWidth:120}]}),p=x([]),h=x(),_=new AbortController,f=x(!1);let I="0",T=0;async function R(){const{data:e,error:s}=await ye({taskBatchId:m.value.taskBatchId,jobId:m.value.jobId,taskId:m.value.id,startId:I,fromIndex:T,size:50});s||(f.value=e.finished,I=e.nextStartId,T=e.fromIndex,e.message&&(p.value.push(...e.message),p.value.sort((u,v)=>Number.parseInt(u.time_stamp,10)-Number.parseInt(v.time_stamp,10))),f.value||(clearTimeout(h.value),h.value=setTimeout(R,1e3)))}const P=()=>{f.value=!0,_.abort(),clearTimeout(h.value),h.value=void 0};return le(()=>{P()}),(e,s)=>{const u=ve,v=Se,g=re,K=H,X=ie,Y=Be,Z=je;return M(),q(Z,{modelValue:c.value,"onUpdate:modelValue":s[2]||(s[2]=l=>c.value=l),title:a(t)("page.jobBatch.detail"),width:["50%","90%"]},{default:r(()=>[o(X,{type:"segment",animated:""},{default:r(()=>[o(g,{name:0,tab:a(t)("page.log.info")},{default:r(()=>[o(v,{"label-placement":"top",bordered:"",column:2},{default:r(()=>[o(u,{label:a(t)("page.jobBatch.groupName")},{default:r(()=>{var l;return[j(y((l=e.rowData)==null?void 0:l.groupName),1)]}),_:1},8,["label"]),o(u,{label:a(t)("page.jobBatch.jobName")},{default:r(()=>{var l;return[j(y((l=e.rowData)==null?void 0:l.jobName),1)]}),_:1},8,["label"]),o(u,{label:a(t)("page.jobBatch.taskBatchStatus")},{default:r(()=>{var l;return[o(a(w),{type:a(L)((l=e.rowData)==null?void 0:l.taskBatchStatus)},{default:r(()=>{var k;return[j(y(a(t)(a(G)[(k=e.rowData)==null?void 0:k.taskBatchStatus])),1)]}),_:1},8,["type"])]}),_:1},8,["label"]),o(u,{label:a(t)("page.jobBatch.executionAt")},{default:r(()=>{var l;return[j(y((l=e.rowData)==null?void 0:l.executionAt),1)]}),_:1},8,["label"]),o(u,{label:a(t)("page.jobBatch.operationReason")},{default:r(()=>{var l;return[o(a(w),{type:a(L)((l=e.rowData)==null?void 0:l.operationReason)},{default:r(()=>{var k;return[j(y(a(t)(a(Q)[(k=e.rowData)==null?void 0:k.operationReason])),1)]}),_:1},8,["type"])]}),_:1},8,["label"]),o(u,{label:a(t)("page.jobBatch.executorType")},{default:r(()=>{var l;return[o(a(w),{type:a(L)((l=e.rowData)==null?void 0:l.executorType)},{default:r(()=>{var k;return[j(y(a(t)(a(se)[(k=e.rowData)==null?void 0:k.executorType])),1)]}),_:1},8,["type"])]}),_:1},8,["label"]),o(u,{label:a(t)("page.jobBatch.executorInfo"),span:2},{default:r(()=>{var l;return[j(y((l=e.rowData)==null?void 0:l.executorInfo),1)]}),_:1},8,["label"]),o(u,{label:a(t)("common.createDt"),span:2},{default:r(()=>{var l;return[j(y((l=e.rowData)==null?void 0:l.createDt),1)]}),_:1},8,["label"])]),_:1})]),_:1},8,["tab"]),o(g,{name:1,tab:a(t)("page.log.title"),"display-directive":"if"},{default:r(()=>[o(K,{columns:a(D),data:a(N),loading:a(b),remote:"","row-key":l=>l.id,pagination:a(B),class:"sm:h-full"},null,8,["columns","data","loading","row-key","pagination"])]),_:1},8,["tab"])]),_:1}),o(Y,{modelValue:p.value,"onUpdate:modelValue":s[0]||(s[0]=l=>p.value=l),show:d.value,"onUpdate:show":s[1]||(s[1]=l=>d.value=l),title:a(t)("page.log.title")},null,8,["modelValue","show","title"])]),_:1},8,["modelValue","title"])}}}),Re={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function C(i){return typeof i=="function"||Object.prototype.toString.call(i)==="[object Object]"&&!E(i)}const qe=z({name:"job_batch",__name:"index",setup(i){const S=ue(),m=ce(),c=x(),{bool:d,setTrue:D}=pe(!1),{columnChecks:N,columns:b,data:B,getData:p,loading:h,mobilePagination:_,searchParams:f,resetSearchParams:I}=O({apiFn:Ne,apiParams:{page:1,size:10,groupName:null,jobName:null,taskBatchStatus:null},columns:()=>[{key:"id",title:t("common.index"),align:"center",width:120,render:n=>{function e(){c.value=n,D()}return o(W,{text:!0,tag:"a",type:"primary",onClick:e,class:"ws-normal"},{default:()=>[n.id]})}},{key:"groupName",title:t("page.jobBatch.groupName"),align:"left",minWidth:120},{key:"jobName",title:t("page.jobBatch.jobName"),align:"center",minWidth:120},{key:"executionAt",title:t("page.jobBatch.executionAt"),align:"center",minWidth:120},{key:"taskBatchStatus",title:t("page.jobBatch.taskBatchStatus"),align:"center",minWidth:120,render:n=>{if(n.taskBatchStatus===null)return null;const e=t(G[n.taskBatchStatus]);return o(w,{type:{1:"info",2:"info",3:"info",4:"error",5:"error",6:"error"}[n.taskBatchStatus]},C(e)?e:{default:()=>[e]})}},{key:"operationReason",title:t("page.jobBatch.operationReason"),align:"center",minWidth:120,render:n=>{if(n.operationReason===null)return null;const e=t(Q[n.operationReason]);return o(w,{type:L(n.operationReason)},C(e)?e:{default:()=>[e]})}},{key:"createDt",title:t("common.createDt"),align:"center",minWidth:120},{key:"operate",title:t("common.operate"),align:"center",width:130,render:n=>o("div",{class:"flex-center gap-8px"},[n.taskBatchStatus===1||n.taskBatchStatus===2?o(A,{onPositiveClick:()=>R(n.id)},{default:()=>t("common.confirmStop"),trigger:()=>{let e;return o(W,{type:"error",text:!0,ghost:!0,size:"small"},C(e=t("common.stop"))?e:{default:()=>[e]})}}):"",n.taskBatchStatus===4||n.taskBatchStatus===5||n.taskBatchStatus===6?o(A,{onPositiveClick:()=>T(n.id)},{default:()=>t("common.confirmRetry"),trigger:()=>{let e;return o(W,{type:"error",text:!0,ghost:!0,size:"small"},C(e=t("common.retry"))?e:{default:()=>[e]})}}):""])}]});async function T(n){var s;const{error:e}=await De(n);e||((s=window.$message)==null||s.success(t("common.operateSuccess")),p())}async function R(n){var s;const{error:e}=await we(n);e||((s=window.$message)==null||s.success(t("common.operateSuccess")),p())}async function P(n){if(!n)f.jobName=null;else{const{data:e,error:s}=await he({jobId:n});if(!s&&e.length>0){const u=e[0].jobName;f.jobName=u}}p()}me(()=>m.query,()=>{if(m.name==="job_batch"&&m.query.jobId){const n=Number(m.query.jobId);P(n)}},{immediate:!0});function $(){const n=history.state.taskBatchStatus;n&&(f.taskBatchStatus=n,p())}return $(),(n,e)=>{const s=ae,u=H,v=fe;return M(),de("div",Re,[o(xe,{model:a(f),"onUpdate:model":e[0]||(e[0]=g=>V(f)?f.value=g:null),onReset:a(I),onSearch:a(p)},null,8,["model","onReset","onSearch"]),o(v,{title:a(t)("page.jobBatch.title"),bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper","header-class":"view-card-header"},{"header-extra":r(()=>[o(s,{columns:a(N),"onUpdate:columns":e[1]||(e[1]=g=>V(N)?N.value=g:null),loading:a(h),"show-delete":!1,"show-add":!1,onRefresh:a(p)},null,8,["columns","loading","onRefresh"])]),default:r(()=>[o(u,{columns:a(b),data:a(B),"flex-height":!a(S).isMobile,"scroll-x":962,loading:a(h),remote:"","row-key":g=>g.id,pagination:a(_),class:"sm:h-full"},null,8,["columns","data","flex-height","loading","row-key","pagination"])]),_:1},8,["title"]),a(d)?(M(),q(Te,{key:0,visible:a(d),"onUpdate:visible":e[2]||(e[2]=g=>V(d)?d.value=g:null),"row-data":c.value},null,8,["visible","row-data"])):be("",!0)])}}});export{qe as default};
